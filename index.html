<!DOCTYPE html>
<html>
<!-- 
  This website was coded by Thies.
  Some code was taken from eenbeetjes.us, a VIA challange website
 -->

<head>
  <title>Is this E-Number vegan?</title>

  <link href="https://code.jquery.com/ui/1.10.4/themes/ui-darkness/jquery-ui.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

  <script>
    let vegan_enumbers_temp = []
    let all_enumbers_temp = []
    let ongoing = null
    async function get_vegan_enumbers() {
      if (vegan_enumbers_temp.length == 0) {
        if (ongoing) {
          await ongoing
        } else {
          const req = await fetch("api/enumbers");
          const html_content = await req.json()
          vegan_enumbers_temp = html_content.vegan
          all_enumbers_temp = html_content.all
        }
        return vegan_enumbers_temp
      } else {
        return vegan_enumbers_temp
      }
    }

    async function get_all_enumbers() {
      if (all_enumbers_temp.length == 0) {
        await get_vegan_enumbers()
        return all_enumbers_temp
      } else {
        return all_enumbers_temp
      }
    }

    (async () => {
      const all_enumbers = await get_all_enumbers()
      $(function () {
        $("#input").autocomplete({
          source: all_enumbers.map(x => {
            return {
              label: `${x.enumber} - ${x.name}`,
              value: x.enumber
            }
          }),
          minLength: 2,
          delay: 0,
          // Automatically hide when a full match is found
          response: function (event, ui) {
            if (event.target.value.toLowerCase() == ui.content?.[0]?.value.toLowerCase()) {
              $(this).autocomplete("close");
              checkEnumber()
            }
          },
          select: function (event, ui) {
            checkEnumber(ui.item.value)
          }
        });
      });
    })();

    async function checkEnumber(override = null) {
      const to_check = (override ?? $("#input").val()).toLowerCase()
      console.log("Getting enumber:", to_check)
      $("#hint").html(`We are checking: ${to_check}`);
      $("#hint").css("color", "black");


      const vegan_enumbers = await get_vegan_enumbers()
      const all_enumbers = await get_all_enumbers()
      const found = vegan_enumbers.find(x => x.enumber.toLowerCase() === to_check)
      const found_all = all_enumbers.find(x => x.enumber.toLowerCase() === to_check)
      $("#desc").html(`${found_all.enumber} - ${found_all.name} -  <a href='https://en.wikipedia.org/wiki/${found_all.enumber}'>Wikipedia</a>`)

      if (found) {
        $("#hint").html(`Yes, <a href='https://en.wikipedia.org/wiki/${found.enumber}'>${found.enumber}</a> is ${found.vegan.toLowerCase()}! ${found.group}`);
        $("#hint").css("color", found.vegan === "Vegan" ? "green" : "orange");
      } else {
        $("#hint").html(`No, ${to_check} is not vegan!`);
        $("#hint").css("color", "red");
      }

    }

  </script>

  <style type="text/css">
    body {
      overflow-x: hidden;
    }

    #bg {
      position: fixed;
      top: 0%;
      left: 0%;
      width: 100%;
      height: 100%;
    }


    p {
      text-align: center;
      font-size: 100pt;
      margin-top: 0px;
      font-family: 'Source Sans Code', monospace;
    }

    a {
      text-align: center;
      font-size: 30pt;
      margin-top: 0px;
      font-family: 'Source Sans Code', monospace;
      color: black;
      text-decoration: none;
      margin-bottom: 20pt;
    }

    #cont {
      margin: 0;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      text-align: center;
    }

    input {
      text-align: center;
      font-size: 75pt;
      margin-top: 0px;
      font-family: 'Source Sans Code', monospace;
      border-top: 0pt;
      border-left: 0pt;
      border-right: 0pt;
      border-bottom: 2px solid #6d6d6d;
      width: 100%;
    }

    input:focus {
      outline: none;
    }

    #hint {
      margin-top: 20pt;
    }

    .small-text {
      font-size: 25pt;
      font-family: 'Source Sans Code', monospace;
      padding: 20pt;
    }

    .small-text a {
      font-size: 25pt;
    }

    footer {
      text-align: center;
      color: black;
      position: absolute;
      bottom: 0;
      padding: 0.3em;
      width: 100vw;
      font-family: sans-serif;
    }
  </style>
</head>

<body>
  <div id="bg">
    <div id="cont">
      <a href="https://sarakidd.com/vegan-e-numbers-list/">Vegan E-Numbers</a>
      <form id="f" onsubmit="event.preventDefault(); checkEnumber()">
        <input type="text" id="input" autofocus placeholder="E100" />
      </form>
      <p id="hint" class="small-text"></p>
      <p id="desc" class="small-text"></p>
    </div>
  </div>
  <footer>By Thies - 2022</footer>
</body>

</html>